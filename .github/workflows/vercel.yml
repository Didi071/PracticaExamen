name: CI/CD - Despliegue en Vercel

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # -------------------------------------------------
  # 1) Verificar archivos JavaScript
  # -------------------------------------------------
  verificar-js:
    name: 1) Verificar archivos .js
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Buscar archivos .js
        run: |
          JS_FILES=$(find . -type f -name "*.js")
          if [ -z "$JS_FILES" ]; then
            echo "‚ùå No se encontraron archivos .js."
            exit 1
          else
            echo "‚úî Archivos .js encontrados."

  # -------------------------------------------------
  # 2) Ejecutar tests unitarios
  # -------------------------------------------------
  tests:
    name: 2) Tests unitarios
    runs-on: ubuntu-latest
    needs: verificar-js
    if: needs.verificar-js.result == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Instalar dependencias
        run: npm ci || npm install

      - name: Ejecutar tests
        run: |
          npm test || (echo "‚ùå Los tests fallaron." && exit 1)
          echo "‚úî Tests unitarios completados correctamente."

  # -------------------------------------------------
  # 3) Generar documentaci√≥n con JSDoc
  # -------------------------------------------------
  docs:
    name: 3) Generar documentaci√≥n
    runs-on: ubuntu-latest
    needs: tests
    if: needs.tests.result == 'success'
    outputs:
      has_docs: ${{ steps.check.outputs.has_docs }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Instalar dependencias
        run: npm install

      - name: Generar documentaci√≥n
        run: |
          mkdir -p docs
          npx jsdoc -c jsdoc.json || true

      - name: Comprobar documentaci√≥n generada
        id: check
        run: |
          COUNT=$(find docs -type f -name "*.html" | wc -l | xargs)
          if [ "$COUNT" -gt 0 ]; then
            echo "‚úî Documentaci√≥n generada ($COUNT archivos HTML)."
            echo "has_docs=true" >> "$GITHUB_OUTPUT"
          else
            echo "‚ö† No se gener√≥ documentaci√≥n HTML."
            echo "has_docs=false" >> "$GITHUB_OUTPUT"

      - name: Avisar falta de documentaci√≥n
        if: steps.check.outputs.has_docs == 'false'
        run: echo "::warning::No se gener√≥ documentaci√≥n. El despliegue se omitir√°."

  # -------------------------------------------------
  # 4) Desplegar a Vercel
  # -------------------------------------------------
  deploy-vercel:
    name: 4) Desplegar a Vercel (producci√≥n)
    runs-on: ubuntu-latest
    needs: docs
    if: needs.docs.outputs.has_docs == 'true'
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Instalar CLI de Vercel
        run: npm install -g vercel@latest

      - name: Comprobar token
        run: |
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "‚ùå No se encontr√≥ VERCEL_TOKEN en los secrets."
            exit 1
          else
            echo "‚úî Token de Vercel listo."
          fi

      - name: Desplegar a Vercel
        run: |
          vercel --prod --yes --token "$VERCEL_TOKEN"
          echo "üöÄ Despliegue a Vercel completado correctamente."
